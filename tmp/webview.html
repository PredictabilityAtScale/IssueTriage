<!DOCTYPE html>
		<html lang="en">
		<head>
			<meta charset="UTF-8">
			<meta http-equiv="Content-Security-Policy" content="${csp}">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
			<title>Issue Triage</title>
			<style nonce="${nonce}">
				:root {
					color-scheme: light dark;
					font-family: var(--vscode-font-family, Segoe WPC, Segoe UI, sans-serif);
					font-size: 13px;
				}

				body {
					margin: 0;
					padding: 0;
					background: var(--vscode-editor-background);
					color: var(--vscode-editor-foreground);
				}

				.header {
					display: flex;
					align-items: center;
					justify-content: space-between;
					padding: 16px;
					border-bottom: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
				}

				.header-left {
					display: flex;
					flex-direction: column;
					gap: 4px;
				}

				.header h1 {
					font-size: 18px;
					margin: 0;
				}

				.toolbar {
					display: flex;
					gap: 8px;
					align-items: center;
				}

				button, select, input[type="search"] {
					font: inherit;
					padding: 6px 10px;
					border-radius: 4px;
					border: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					background: var(--vscode-editor-background);
					color: inherit;
				}

				button.primary {
					background: var(--vscode-button-background);
					color: var(--vscode-button-foreground);
					border-color: transparent;
				}

				button:disabled {
					opacity: 0.6;
					cursor: not-allowed;
				}

				.container {
					display: grid;
					grid-template-columns: 1fr;
					height: calc(100vh - 60px);
				}

				@media (min-width: 960px) {
					.container {
						grid-template-columns: 320px 1fr;
					}
				}

				.sidebar {
					border-right: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					padding: 16px;
					overflow-y: auto;
				}

				.content {
					padding: 16px;
					overflow-y: auto;
				}

				.issue-list {
					display: grid;
					gap: 8px;
				}

				.filters {
					display: grid;
					gap: 12px;
					margin-top: 16px;
				}

				.filters label {
					display: flex;
					flex-direction: column;
					gap: 4px;
					font-size: 11px;
					text-transform: uppercase;
					letter-spacing: 0.05em;
					color: var(--vscode-descriptionForeground, var(--vscode-foreground));
				}

				.filters label > span {
					font-weight: 600;
				}

				.filters select,
				.filters input[type="search"] {
					width: 100%;
					margin: 0;
				}

				.issue-card {
					padding: 12px;
					border-radius: 6px;
					border: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					background: color-mix(in srgb, var(--vscode-editor-background) 92%, var(--vscode-button-background) 8%);
					cursor: pointer;
					transition: border-color 0.1s ease, background 0.1s ease;
				}

				.issue-card-header {
					display: flex;
					align-items: center;
					justify-content: space-between;
					gap: 12px;
					margin-bottom: 8px;
				}

				.overview-grid {
					display: grid;
					gap: 12px;
					grid-template-columns: repeat(auto-fit, minmax(clamp(100px, 22vw, 160px), 1fr));
				}

				.issue-card.selected {
					border-color: var(--vscode-button-background);
					background: color-mix(in srgb, var(--vscode-editor-background) 80%, var(--vscode-button-background) 20%);
				}

				.issue-card h3 {
					margin: 0;
					font-size: 14px;
					overflow: hidden;
					text-overflow: ellipsis;
					white-space: nowrap;
				}

				.risk-badge {
					padding: 2px 6px;
					border-radius: 999px;
					font-size: 11px;
					border: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					text-transform: uppercase;
					letter-spacing: 0.05em;
				}

				.risk-badge.risk-low {
					background: color-mix(in srgb, var(--vscode-testing-iconPassed, #2ea043) 18%, transparent);
					border-color: color-mix(in srgb, var(--vscode-testing-iconPassed, #2ea043) 35%, transparent);
				}

				.risk-badge.risk-medium {
					background: rgba(187, 128, 9, 0.2);
					border-color: rgba(187, 128, 9, 0.4);
				}

				.risk-badge.risk-high {
					background: rgba(229, 83, 75, 0.25);
					border-color: rgba(229, 83, 75, 0.55);
				}

				.risk-badge.risk-pending {
					background: color-mix(in srgb, var(--vscode-editor-background) 92%, transparent);
					border-style: dashed;
				}

				.risk-badge.risk-error {
					background: rgba(229, 83, 75, 0.15);
					border-color: rgba(229, 83, 75, 0.45);
				}

				.risk-badge.risk-stale {
					border-style: dashed;
				}

				.issue-card-actions {
					display: flex;
					align-items: center;
					gap: 6px;
				}

				.issue-action {
					padding: 4px 10px;
					font-size: 12px;
					border-radius: 4px;
					border: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					background: color-mix(in srgb, var(--vscode-editor-background) 92%, var(--vscode-button-background) 8%);
					cursor: pointer;
					text-transform: uppercase;
					letter-spacing: 0.05em;
				}

				.issue-action:hover {
					border-color: var(--vscode-button-background);
				}

				.issue-action:disabled {
					opacity: 0.6;
					cursor: not-allowed;
				}

				.meta-row {
					display: flex;
					flex-wrap: wrap;
					gap: 6px;
					font-size: 12px;
				}

				.badge {
					padding: 2px 6px;
					border-radius: 999px;
					background: color-mix(in srgb, var(--vscode-editor-background) 85%, var(--vscode-button-background) 15%);
				}

				.status {
					padding: 12px;
					border-radius: 6px;
					border: 1px dashed var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					margin-bottom: 16px;
				}

				.empty-state {
					text-align: center;
					padding: 48px 16px;
					border: 1px dashed var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					border-radius: 6px;
				}

				.assessment-panel {
					margin-top: 24px;
					padding: 16px;
					border-radius: 6px;
					border: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					background: color-mix(in srgb, var(--vscode-editor-background) 96%, var(--vscode-button-background) 4%);
				}

				.assessment-panel h2 {
					margin: 0 0 4px 0;
					font-size: 16px;
				}

				.assessment-panel p {
					margin: 4px 0;
				}

				.assessment-empty,
				.assessment-loading,
				.assessment-error {
					text-align: center;
					padding: 24px 8px;
					color: var(--vscode-descriptionForeground, var(--vscode-foreground));
				}

				.score-grid {
					display: grid;
					grid-template-columns: repeat(auto-fit, minmax(clamp(88px, 18vw, 132px), 1fr));
					gap: 12px;
					margin: 16px 0;
				}

				.score-card {
					border: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					border-radius: 6px;
					padding: 10px;
					background: color-mix(in srgb, var(--vscode-editor-background) 90%, var(--vscode-button-background) 10%);
				}

				.score-card strong {
					display: block;
					font-size: 11px;
					text-transform: uppercase;
					letter-spacing: 0.05em;
					margin-bottom: 4px;
				}
				.assessment-actions {
					display: flex;
					gap: 8px;
					flex-wrap: wrap;
					margin-top: 16px;
				}

				.button-link {
					background: none;
					border: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					border-radius: 4px;
					padding: 6px 10px;
					color: inherit;
					cursor: pointer;
				}

				.button-link:hover {
					border-color: var(--vscode-button-background);
				}

				.automation-badge {
					padding: 2px 8px;
					border-radius: 999px;
					font-size: 11px;
					border: 1px solid var(--vscode-input-border, rgba(128,128,128,0.35));
				}

				.automation-badge.enabled {
					background: color-mix(in srgb, var(--vscode-testing-iconPassed, #2ea043) 18%, transparent);
					border-color: color-mix(in srgb, var(--vscode-testing-iconPassed, #2ea043) 35%, transparent);
				}

				.automation-badge.disabled {
					background: color-mix(in srgb, var(--vscode-editor-background) 92%, transparent);
					border-style: dashed;
				}

				.readiness-pill {
					display: inline-block;
					padding: 4px 10px;
					border-radius: 999px;
					font-size: 12px;
					font-weight: 600;
					text-transform: uppercase;
					border: 1px solid rgba(128,128,128,0.45);
				}

				.readiness-ready {
					background: rgba(46, 160, 67, 0.2);
					border-color: rgba(46, 160, 67, 0.5);
				}

				.readiness-prepare {
					background: rgba(187, 128, 9, 0.2);
					border-color: rgba(187, 128, 9, 0.5);
				}

				.readiness-review {
					background: rgba(229, 140, 33, 0.25);
					border-color: rgba(229, 140, 33, 0.55);
				}

				.readiness-manual {
					background: rgba(229, 83, 75, 0.25);
					border-color: rgba(229, 83, 75, 0.55);
				}

				.risk-section {
					margin-top: 24px;
					padding: 16px;
					border-radius: 6px;
					border: 1px solid var(--vscode-editorWidget-border, rgba(128,128,128,0.35));
					background: color-mix(in srgb, var(--vscode-editor-background) 95%, var(--vscode-button-background) 5%);
				}

				.risk-section h3 {
					margin-top: 0;
					margin-bottom: 8px;
				}

				.risk-level {
					font-weight: 600;
					margin-bottom: 12px;
				}

				.risk-level.risk-low {
					color: var(--vscode-testing-iconPassed, #2ea043);
				}

				.risk-level.risk-medium {
					color: rgba(187, 128, 9, 0.95);
				}

				.risk-level.risk-high {
					color: rgba(229, 83, 75, 0.95);
				}

				.risk-columns {
					display: grid;
					gap: 16px;
					grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
					margin-top: 12px;
				}

				.risk-metrics,
				.risk-drivers {
					margin: 0;
					padding-left: 18px;
				}

				.risk-metrics li,
				.risk-drivers li {
					margin-bottom: 6px;
				}

				.risk-meta {
					font-size: 12px;
					color: var(--vscode-descriptionForeground, var(--vscode-foreground));
					margin: 4px 0;
				}
			</style>
		</head>
		<body>
			<div class="header">
				<div class="header-left">
					<h1>Issue Triage</h1>
					<div class="meta-row">
						<span id="accountLabel"></span>
						<span id="automationBadge" class="automation-badge" role="status" aria-live="polite"></span>
					</div>
				</div>
				<div class="toolbar">
					<button id="connect" class="primary">Connect GitHub</button>
					<button id="refresh">Refresh</button>
				</div>
			</div>
			<div class="container">
				<aside class="sidebar">
					<div class="status" id="statusBlock">Sign in to connect your repository.</div>
					<div class="filters" aria-live="polite">
						<label>
							<span>Repository</span>
							<select id="repositorySelect"></select>
						</label>
						<label>
							<span>Search</span>
							<input type="search" id="searchInput" placeholder="Search titles" />
						</label>
						<label>
							<span>Label</span>
							<select id="labelFilter"></select>
						</label>
						<label>
							<span>Assignee</span>
							<select id="assigneeFilter"></select>
						</label>
						<label>
							<span>Milestone</span>
							<select id="milestoneFilter"></select>
						</label>
					</div>
				</aside>
				<main class="content">
					<div id="issueSummary" class="meta-row"></div>
					<section id="issueList" class="issue-list"></section>
					<div id="emptyState" class="empty-state" hidden>
						<p>No issues match your filters.</p>
					</div>
					<section id="assessmentPanel" class="assessment-panel" aria-live="polite"></section>
				</main>
			</div>

			<script nonce="${nonce}">
				const vscodeApi = acquireVsCodeApi();
				const connectButton = document.getElementById('connect');
				const refreshButton = document.getElementById('refresh');
				const repositorySelect = document.getElementById('repositorySelect');
				const searchInput = document.getElementById('searchInput');
				const labelFilter = document.getElementById('labelFilter');
				const assigneeFilter = document.getElementById('assigneeFilter');
				const milestoneFilter = document.getElementById('milestoneFilter');
				const statusBlock = document.getElementById('statusBlock');
				const issueList = document.getElementById('issueList');
				const emptyState = document.getElementById('emptyState');
				const issueSummary = document.getElementById('issueSummary');
				const accountLabel = document.getElementById('accountLabel');
				const automationBadge = document.getElementById('automationBadge');
				const assessmentPanel = document.getElementById('assessmentPanel');

				let latestState = null;
				let selectedIssueNumber = undefined;
				let latestAssessment = null;

				window.addEventListener('message', event => {
					const message = event.data;
					if (!message) {
						return;
					}
					switch (message.type) {
						case 'stateUpdate':
							latestState = message.state;
							renderState(latestState);
							break;
						case 'assessment.loading':
							if (message.issueNumber === selectedIssueNumber) {
								renderAssessmentLoading();
							}
							break;
						case 'assessment.result':
							if (message.issueNumber === selectedIssueNumber) {
								if (message.assessment) {
									renderAssessmentResult(message.assessment);
								} else {
									renderAssessmentEmpty('Run an IssueTriage assessment to populate this panel.');
								}
							}
							break;
						case 'assessment.error':
							if (message.issueNumber === selectedIssueNumber) {
								renderAssessmentError(typeof message.message === 'string' ? message.message : 'Unable to load assessment.');
							}
							break;
						default:
							break;
					}
				});

				connectButton.addEventListener('click', () => {
					vscodeApi.postMessage({ type: 'webview.connect' });
				});

				refreshButton.addEventListener('click', () => {
					vscodeApi.postMessage({ type: 'webview.refresh' });
				});

				repositorySelect.addEventListener('change', event => {
					const value = event.target.value;
					vscodeApi.postMessage({ type: 'webview.selectRepository', repository: value });
				});

				function onFilterChanged() {
					const filters = {
						search: searchInput.value || undefined,
						label: labelFilter.value || undefined,
						assignee: assigneeFilter.value || undefined,
						milestone: milestoneFilter.value || undefined
					};
					vscodeApi.postMessage({ type: 'webview.filtersChanged', filters });
				}

				searchInput.addEventListener('input', onFilterChanged);
				labelFilter.addEventListener('change', onFilterChanged);
				assigneeFilter.addEventListener('change', onFilterChanged);
				milestoneFilter.addEventListener('change', onFilterChanged);

				issueList.addEventListener('click', event => {
					const actionButton = event.target.closest('button[data-action]');
					if (actionButton && issueList.contains(actionButton)) {
						const action = actionButton.getAttribute('data-action');
						const issueAttr = actionButton.getAttribute('data-issue-number');
						const issueNumber = Number(issueAttr);
						if (action === 'runAssessment' && Number.isFinite(issueNumber)) {
							event.preventDefault();
							event.stopPropagation();
							selectIssue(issueNumber);
							vscodeApi.postMessage({ type: 'webview.runAssessment', issueNumber });
						}
						return;
					}
					const card = event.target.closest('.issue-card');
					if (!card) {
						return;
					}
					const issueNumber = Number(card.getAttribute('data-issue-number'));
					if (Number.isNaN(issueNumber)) {
						return;
					}
					selectIssue(issueNumber);
				});

				issueList.addEventListener('dblclick', event => {
					const actionButton = event.target.closest('button[data-action]');
					if (actionButton) {
						event.preventDefault();
						return;
					}
					const card = event.target.closest('.issue-card');
					if (!card) {
						return;
					}
					const url = card.getAttribute('data-url');
					if (url) {
						vscodeApi.postMessage({ type: 'webview.openIssue', url });
					}
				});

				assessmentPanel.addEventListener('click', event => {
					const button = event.target.closest('button[data-action]');
					if (!button) {
						return;
					}
					const action = button.getAttribute('data-action');
					if (action === 'openIssue') {
						const issueUrl = getIssueUrl(selectedIssueNumber);
						if (issueUrl) {
							vscodeApi.postMessage({ type: 'webview.openIssue', url: issueUrl });
						}
					} else if (action === 'openComment') {
						const commentUrl = button.getAttribute('data-url');
						if (commentUrl) {
							vscodeApi.postMessage({ type: 'webview.openUrl', url: commentUrl });
						}
					}
				});

				function renderState(state) {
					const { loading, session, repositories, selectedRepository, issues, issueMetadata, filters, error, lastUpdated, automationLaunchEnabled } = state;

					connectButton.disabled = loading;
					refreshButton.disabled = loading || !selectedRepository;

					if (session) {
						accountLabel.textContent = 'Signed in as ' + session.login;
						statusBlock.textContent = selectedRepository ? 'Connected to ' + selectedRepository.fullName : 'Select a repository to get started.';
					} else {
						accountLabel.textContent = 'Not signed in';
						statusBlock.textContent = 'Sign in to connect your repository.';
					}

					if (automationLaunchEnabled) {
						automationBadge.textContent = 'Automation Launch Enabled';
						automationBadge.classList.add('enabled');
						automationBadge.classList.remove('disabled');
					} else {
						automationBadge.textContent = 'Automation Launch Disabled';
						automationBadge.classList.add('disabled');
						automationBadge.classList.remove('enabled');
					}

					if (error) {
						statusBlock.textContent = error;
					}

					repositorySelect.innerHTML = '';
					const defaultOption = document.createElement('option');
					defaultOption.value = '';
					defaultOption.textContent = repositories.length ? 'Select repository' : 'No repositories available';
					repositorySelect.appendChild(defaultOption);
					repositories.forEach(repo => {
						const option = document.createElement('option');
						option.value = repo.fullName;
						option.textContent = repo.fullName;
						if (selectedRepository && repo.fullName === selectedRepository.fullName) {
							option.selected = true;
						}
						repositorySelect.appendChild(option);
					});

					renderFilterOptions(labelFilter, issueMetadata.labels, filters.label, 'All labels');
					renderFilterOptions(assigneeFilter, issueMetadata.assignees, filters.assignee, 'All assignees');
					renderFilterOptions(milestoneFilter, issueMetadata.milestones, filters.milestone, 'All milestones');

					if (!loading && issues.length === 0) {
						emptyState.hidden = false;
						issueList.innerHTML = '';
					} else {
						emptyState.hidden = true;
						issueList.innerHTML = issues.map(issue => renderIssue(issue)).join('');
					}

					if (selectedRepository) {
						const summaryBase = issues.length + ' open issues';
						const updatedText = lastUpdated ? ' · Updated ' + new Date(lastUpdated).toLocaleString() : '';
						issueSummary.textContent = summaryBase + updatedText;
					} else {
						issueSummary.textContent = '';
					}

					enforceSelection();
					renderRiskDisplay(selectedIssueNumber);
				}

				function renderFilterOptions(selectElement, values, selectedValue, placeholder) {
					selectElement.innerHTML = '';
					const option = document.createElement('option');
					option.value = '';
					option.textContent = placeholder;
					selectElement.appendChild(option);
					values.forEach(value => {
						const optionEl = document.createElement('option');
						optionEl.value = value;
						optionEl.textContent = value;
						if (value === selectedValue) {
							optionEl.selected = true;
						}
						selectElement.appendChild(optionEl);
					});
				}

				function getRiskSummary(issueNumber) {
					if (!latestState || !latestState.riskSummaries) {
						return undefined;
					}
					return latestState.riskSummaries[issueNumber];
				}

				function escapeHtml(value) {
					if (typeof value !== 'string' || value.length === 0) {
						return '';
					}
					return value.replace(/[&<>"']/g, character => {
						switch (character) {
							case '&':
								return '&amp;';
							case '<':
								return '&lt;';
							case '>':
								return '&gt;';
							case '"':
								return '&quot;';
							case '\'':
								return '&#39;';
							default:
								return character;
						}
					});
				}

				function renderRiskBadge(summary) {
					if (!summary) {
						return '';
					}
					if (summary.status === 'skipped') {
						return '';
					}
					if (summary.status === 'pending') {
						return '<span class="badge risk-badge risk-pending">Risk Pending</span>';
					}
					if (summary.status === 'error') {
						return '<span class="badge risk-badge risk-error">Risk Error</span>';
					}
					const level = summary.riskLevel ?? 'low';
					let label = level.charAt(0).toUpperCase() + level.slice(1) + ' Risk';
					const classes = ['badge', 'risk-badge', 'risk-' + level];
					if (summary.stale) {
						classes.push('risk-stale');
						label += ' (refreshing)';
					}
					return '<span class="' + classes.join(' ') + '">' + label + '</span>';
				}

				function renderRiskSection(summary) {
					const header = '<section class="risk-section"><h3>Risk Intelligence</h3>';
					if (!summary) {
						return header + '<p>No risk signals captured yet.</p></section>';
					}
					if (summary.status === 'pending') {
						return header + '<p>Collecting historical risk signals…</p></section>';
					}
					if (summary.status === 'error') {
						const message = summary.message ? escapeHtml(summary.message) : 'An unexpected error occurred.';
						return header + '<p>Unable to load risk insights: ' + message + '</p></section>';
					}
					if (summary.status === 'skipped') {
						const message = summary.message ? escapeHtml(summary.message) : 'Risk analysis skipped by configuration.';
						return header + '<p>' + message + '</p></section>';
					}
					const level = summary.riskLevel ?? 'low';
					const levelLabel = level.charAt(0).toUpperCase() + level.slice(1);
					const scoreText = typeof summary.riskScore === 'number' ? summary.riskScore.toFixed(0) : 'n/a';
					const metricsItems = [];
					if (summary.metrics) {
						metricsItems.push(String(summary.metrics.prCount) + ' linked pull requests');
						metricsItems.push(String(summary.metrics.filesTouched) + ' files touched');
						metricsItems.push(String(summary.metrics.changeVolume) + ' lines changed');
						metricsItems.push(String(summary.metrics.reviewCommentCount) + ' review friction signals');
					}
					const metricsHtml = metricsItems.length
						? '<ul class="risk-metrics">' + metricsItems.map(item => '<li>' + escapeHtml(item) + '</li>').join('') + '</ul>'
						: '<p class="risk-meta">No metrics available yet.</p>';
					const driversHtml = summary.topDrivers && summary.topDrivers.length
						? summary.topDrivers.map(item => '<li>' + escapeHtml(item) + '</li>').join('')
						: '<li>No dominant risk drivers detected.</li>';
					const staleNotice = summary.stale ? '<p class="risk-meta">Signals refreshing…</p>' : '';
					const timestamp = summary.calculatedAt ? '<p class="risk-meta">Last updated ' + new Date(summary.calculatedAt).toLocaleString() + '</p>' : '';
					return header +
						'<p class="risk-level risk-' + level + '">' + levelLabel + ' risk · Score ' + scoreText + '</p>' +
						staleNotice +
						timestamp +
						'<div class="risk-columns">' +
							'<div><h4>Key metrics</h4>' + metricsHtml + '</div>' +
							'<div><h4>Top drivers</h4><ul class="risk-drivers">' + driversHtml + '</ul></div>' +
						'</div>' +
					'</section>';
				}

				function renderRiskDisplay(issueNumber) {
					const container = assessmentPanel.querySelector('#riskSection');
					if (!container) {
						return;
					}
					const summary = typeof issueNumber === 'number' ? getRiskSummary(issueNumber) : undefined;
					container.innerHTML = renderRiskSection(summary);
				}

				function renderIssue(issue) {
					const labelBadges = issue.labels.map(label => '<span class="badge">' + escapeHtml(label) + '</span>').join(' ');
					const assigneeText = issue.assignees.length ? '· Assigned to ' + issue.assignees.map(name => escapeHtml(name)).join(', ') : '';
					const milestoneText = issue.milestone ? '· Milestone ' + escapeHtml(issue.milestone) : '';
					const updatedText = new Date(issue.updatedAt).toLocaleString();
					const riskSummary = getRiskSummary(issue.number);
					const riskBadge = renderRiskBadge(riskSummary);
					const header = '<div class="issue-card-header"><div class="issue-card-title"><h3>#' + issue.number + ' · ' + escapeHtml(issue.title) + '</h3></div><div class="issue-card-actions">' + (riskBadge || '') + '<button type="button" class="issue-action" data-action="runAssessment" data-issue-number="' + issue.number + '">Run Assessment</button></div></div>';
					const labelRow = labelBadges ? '<div class="meta-row">' + labelBadges + '</div>' : '';
					return '<article class="issue-card" data-issue-number="' + issue.number + '" data-url="' + issue.url + '">' +
						header +
						'<div class="meta-row">' +
							'<span>Updated ' + updatedText + '</span>' +
							(assigneeText ? '<span>' + assigneeText + '</span>' : '') +
							(milestoneText ? '<span>' + milestoneText + '</span>' : '') +
						'</div>' +
						labelRow +
					'</article>';
				}

				function enforceSelection() {
					if (!latestState || !latestState.selectedRepository) {
						selectedIssueNumber = undefined;
						renderAssessmentEmpty('Connect to a repository to view assessments.');
						return;
					}
					if (!latestState.issues.length) {
						selectedIssueNumber = undefined;
						renderAssessmentEmpty('No assessments yet. Run an IssueTriage assessment to populate this panel.');
						return;
					}
					const existingNumbers = latestState.issues.map(issue => issue.number);
					if (!selectedIssueNumber || !existingNumbers.includes(selectedIssueNumber)) {
						selectIssue(existingNumbers[0]);
					} else {
						highlightSelectedIssue();
					}
				}

				function selectIssue(issueNumber) {
					if (selectedIssueNumber === issueNumber) {
						highlightSelectedIssue();
						return;
					}
					selectedIssueNumber = issueNumber;
					latestAssessment = null;
					highlightSelectedIssue();
					renderAssessmentLoading();
					if (latestState && latestState.selectedRepository) {
						vscodeApi.postMessage({ type: 'webview.selectIssue', issueNumber });
					}
				}

				function highlightSelectedIssue() {
					const cards = issueList.querySelectorAll('.issue-card');
					cards.forEach(card => {
						const number = Number(card.getAttribute('data-issue-number'));
						if (!Number.isNaN(number) && number === selectedIssueNumber) {
							card.classList.add('selected');
						} else {
							card.classList.remove('selected');
						}
					});
				}

				function getIssueUrl(issueNumber) {
					if (!latestState) {
						return undefined;
					}
					const issue = latestState.issues.find(item => item.number === issueNumber);
					return issue ? issue.url : undefined;
				}

				function getReadiness(score) {
					if (score >= 80) {
						return { label: 'Automation Ready', className: 'readiness-ready', description: 'Safe to hand off to automation.' };
					}
					if (score >= 60) {
						return { label: 'Prep Required', className: 'readiness-prepare', description: 'Add missing context then reassess.' };
					}
					if (score >= 40) {
						return { label: 'Needs Review', className: 'readiness-review', description: 'Human review recommended before automation.' };
					}
					return { label: 'Manual Only', className: 'readiness-manual', description: 'Keep this issue manual for now.' };
				}

				function renderAssessmentLoading() {
					assessmentPanel.innerHTML = '<div class="assessment-loading">Loading latest assessment…</div><div id="riskSection"></div>';
					renderRiskDisplay(selectedIssueNumber);
				}

				function renderAssessmentEmpty(message) {
					latestAssessment = null;
					assessmentPanel.innerHTML = '<div class="assessment-empty">' + message + '</div><div id="riskSection"></div>';
					renderRiskDisplay(selectedIssueNumber);
				}

				function renderAssessmentError(message) {
					latestAssessment = null;
					assessmentPanel.innerHTML = '<div class="assessment-error">' + message + '</div><div id="riskSection"></div>';
					renderRiskDisplay(selectedIssueNumber);
				}

				function renderAssessmentResult(data) {
					latestAssessment = data;
					const readiness = getReadiness(data.compositeScore);
					const updatedAt = new Date(data.createdAt).toLocaleString();
					const issueUrl = getIssueUrl(data.issueNumber);
					const recommendations = (data.recommendations && data.recommendations.length ? data.recommendations : ['No immediate actions recommended.']).map(item => '<li>' + item + '</li>').join('');
					const lines = [
						'<div>',
						'<h2>Assessment · #' + data.issueNumber + '</h2>',
						'<p><span class="readiness-pill ' + readiness.className + '">' + readiness.label + '</span></p>',
						'<p>' + readiness.description + '</p>',
						'<p>Composite ' + data.compositeScore.toFixed(1) + ' · Model ' + data.model + ' · Last run ' + updatedAt + '</p>',
						'</div>',
						'<div class="score-grid">',
						'<div class="score-card"><strong>Composite</strong><span>' + data.compositeScore.toFixed(1) + '</span></div>',
						'<div class="score-card"><strong>Requirements</strong><span>' + data.requirementsScore.toFixed(1) + '</span></div>',
						'<div class="score-card"><strong>Complexity</strong><span>' + data.complexityScore.toFixed(1) + '</span></div>',
						'<div class="score-card"><strong>Security</strong><span>' + data.securityScore.toFixed(1) + '</span></div>',
						'<div class="score-card"><strong>Business</strong><span>' + data.businessScore.toFixed(1) + '</span></div>',
						'</div>',
						'<div>',
						'<h3>Summary</h3>',
						'<p>' + data.summary + '</p>',
						'</div>',
						'<div>',
						'<h3>Recommendations</h3>',
						'<ul class="recommendations-list">' + recommendations + '</ul>',
						'</div>',
						'<div class="assessment-actions">'
					];
					if (issueUrl) {
						lines.push('<button class="button-link" data-action="openIssue">Open Issue</button>');
					}
					if (data.commentUrl) {
						lines.push('<button class="button-link" data-action="openComment" data-url="' + data.commentUrl + '">View Latest Comment</button>');
					}
					lines.push('</div>');
					assessmentPanel.innerHTML = lines.join('') + '<div id="riskSection"></div>';
					renderRiskDisplay(data.issueNumber);
				}

				vscodeApi.postMessage({ type: 'webview.ready' });
			</script>
		</body>
		</html>